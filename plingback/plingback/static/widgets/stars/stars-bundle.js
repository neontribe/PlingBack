(function(b){b.widget("ui.stars",{options:{inputType:"radio",split:0,disabled:false,cancelTitle:"Cancel Rating",cancelValue:0,cancelShow:true,disableValue:true,oneVoteOnly:false,showTitles:false,captionEl:null,callback:null,starWidth:16,cancelClass:"ui-stars-cancel",starClass:"ui-stars-star",starOnClass:"ui-stars-star-on",starHoverClass:"ui-stars-star-hover",starDisabledClass:"ui-stars-star-disabled",cancelHoverClass:"ui-stars-cancel-hover",cancelDisabledClass:"ui-stars-cancel-disabled"},_create:function(){function d(g,
h){if(g!=-1){var j=h?a.starHoverClass:a.starOnClass,i=h?a.starOnClass:a.starHoverClass;c.$stars.eq(g).prevAll("."+a.starClass).andSelf().removeClass(i).addClass(j);c.$stars.eq(g).nextAll("."+a.starClass).removeClass(a.starHoverClass+" "+a.starOnClass);c._showCap(a.id2title[g])}else e()}function e(){c.$stars.removeClass(a.starOnClass+" "+a.starHoverClass);c._showCap("")}var c=this,a=this.options,f=0;this.element.data("former.stars",this.element.html());a.isSelect=a.inputType=="select";this.$form=b(this.element).closest("form");
this.$selec=a.isSelect?b("select",this.element):null;this.$rboxs=a.isSelect?b("option",this.$selec):b(":radio",this.element);this.$stars=this.$rboxs.map(function(g){var h={value:this.value,title:(a.isSelect?this.text:this.title)||this.value,isDefault:a.isSelect&&this.defaultSelected||this.defaultChecked};if(g==0){a.split=typeof a.split!="number"?0:a.split;a.val2id=[];a.id2val=[];a.id2title=[];a.name=a.isSelect?c.$selec.get(0).name:this.name;a.disabled=a.disabled||(a.isSelect?b(c.$selec).attr("disabled"):
b(this).attr("disabled"))}if(h.value==a.cancelValue){a.cancelTitle=h.title;return null}a.val2id[h.value]=f;a.id2val[f]=h.value;a.id2title[f]=h.title;if(h.isDefault){a.checked=f;a.value=a.defaultValue=h.value;a.title=h.title}g=b("<div/>").addClass(a.starClass);h=b("<a/>").attr("title",a.showTitles?h.title:"").text(h.value);if(a.split){var j=f%a.split,i=Math.floor(a.starWidth/a.split);g.width(i);h.css("margin-left","-"+j*i+"px")}f++;return g.append(h).get(0)});a.items=f;a.isSelect?this.$selec.remove():
this.$rboxs.remove();this.$cancel=b("<div/>").addClass(a.cancelClass).append(b("<a/>").attr("title",a.showTitles?a.cancelTitle:"").text(a.cancelValue));a.cancelShow&=!a.disabled&&!a.oneVoteOnly;a.cancelShow&&this.element.append(this.$cancel);this.element.append(this.$stars);if(a.checked===undefined){a.checked=-1;a.value=a.defaultValue=a.cancelValue;a.title=""}this.$value=b("<input type='hidden' name='"+a.name+"' value='"+a.value+"' />");this.element.append(this.$value);this.$stars.bind("click.stars",
function(g){if(!a.forceSelect&&a.disabled)return false;var h=c.$stars.index(this);a.checked=h;a.value=a.id2val[h];a.title=a.id2title[h];c.$value.attr({disabled:a.disabled?"disabled":"",value:a.value});d(h,false);c._disableCancel();!a.forceSelect&&c.callback(g,"star")}).bind("mouseover.stars",function(){if(a.disabled)return false;var g=c.$stars.index(this);d(g,true)}).bind("mouseout.stars",function(){if(a.disabled)return false;d(c.options.checked,false)});this.$cancel.bind("click.stars",function(g){if(!a.forceSelect&&
(a.disabled||a.value==a.cancelValue))return false;a.checked=-1;a.value=a.cancelValue;a.title="";c.$value.val(a.value);a.disableValue&&c.$value.attr({disabled:"disabled"});e();c._disableCancel();!a.forceSelect&&c.callback(g,"cancel")}).bind("mouseover.stars",function(){if(c._disableCancel())return false;c.$cancel.addClass(a.cancelHoverClass);e();c._showCap(a.cancelTitle)}).bind("mouseout.stars",function(){if(c._disableCancel())return false;c.$cancel.removeClass(a.cancelHoverClass);c.$stars.triggerHandler("mouseout.stars")});
this.$form.bind("reset.stars",function(){!a.disabled&&c.select(a.defaultValue)});b(window).unload(function(){c.$cancel.unbind(".stars");c.$stars.unbind(".stars");c.$form.unbind(".stars");c.$selec=c.$rboxs=c.$stars=c.$value=c.$cancel=c.$form=null});this.select(a.value);a.disabled&&this.disable()},_disableCancel:function(){var d=this.options,e=d.disabled||d.oneVoteOnly||d.value==d.cancelValue;e?this.$cancel.removeClass(d.cancelHoverClass).addClass(d.cancelDisabledClass):this.$cancel.removeClass(d.cancelDisabledClass);
this.$cancel.css("opacity",e?0.5:1);return e},_disableAll:function(){var d=this.options;this._disableCancel();d.disabled?this.$stars.filter("div").addClass(d.starDisabledClass):this.$stars.filter("div").removeClass(d.starDisabledClass)},_showCap:function(d){var e=this.options;e.captionEl&&e.captionEl.text(d)},value:function(){return this.options.value},select:function(d){var e=this.options;d=d==e.cancelValue?this.$cancel:this.$stars.eq(e.val2id[d]);e.forceSelect=true;d.triggerHandler("click.stars");
e.forceSelect=false},selectID:function(d){var e=this.options;d=d==-1?this.$cancel:this.$stars.eq(d);e.forceSelect=true;d.triggerHandler("click.stars");e.forceSelect=false},enable:function(){this.options.disabled=false;this._disableAll()},disable:function(){this.options.disabled=true;this._disableAll()},destroy:function(){this.$form.unbind(".stars");this.$cancel.unbind(".stars").remove();this.$stars.unbind(".stars").remove();this.$value.remove();this.element.unbind(".stars").html(this.element.data("former.stars")).removeData("stars");
return this},callback:function(d,e){var c=this.options;c.callback&&c.callback(this,e,c.value,d);c.oneVoteOnly&&!c.disabled&&this.disable()}});b.extend(b.ui.stars,{version:"3.0.1"})})(jQuery);var stars=function(){function b(){c.text("");f.html("Saving").fadeIn(30)}function d(){$.ajax({url:"/api/plings/"+e.pling_id+"/ratings",dataType:"json",success:function(g){$("#rating_title").text("Average Rating");$("#rat").data("stars").select((Math.round(g.results.mean/20)*20).toString());c.text(" ("+g.results.count+" vote"+(g.results.count>1?"s":"")+")");f.text("Thanks!").stop().css("opacity",1).fadeIn(30);setTimeout(function(){$("#messages").fadeOut(1E3)},2E3)}})}var e=null,c=$('<span id="caption"></span>'),
a=$('<span id="message_holder"><span id="messages"></span></span>'),f=$("#messages",a);return{init:function(){e=pb.configure();e.plingback_type="stars";e.plingback_version="0.2 alpha";$("#rat").children().not("select, #rating_title").hide();$("#rat").stars({inputType:"select",captionEl:c,oneVoteOnly:true,callback:function(g){pb.api.send({target:{form:g.$form}})}});a.appendTo("#details");c.appendTo("#details");pb.api.bind(pb.api.events.formSending.toString(),b);pb.api.bind(pb.api.events.formSent.toString(),
d);$("#ui").fadeIn()}}}();stars.init();var scope_name="plingback";window[scope_name]={};var pb=window[scope_name];pb.config={gen_feedback_id:true,fixed_feedback_id:false,feedback_uri:null};
pb.configure=function(){pb.config.plings_endpoint="http://feeds.plings.net/activity.php/";pb.config.pling_id=pb.utils.getParameterByName("pling_id");if(pb.config.gen_feedback_id)pb.config.feedback_id=pb.utils.genUUID();if(pb.config.fixed_feedback_id)pb.config.feedback_id=pb.config.fixed_feedback_id;pb.config.multiuser=pb.utils.getParameterByName("multiuser")?true:false;pb.config.thanks_url_id=pb.utils.getParameterByName("thanks_url");pb.config.plingback_endpoint="/api/plingbacks";return pb.config};
pb.api=$({});
pb.api.events={plingLoaded:{name:"plingLoaded",doc:"Triggered when pling data has been fetched. Provides access to the data as event.pling",attrs:["pling"],toString:function(){return this.name}},formSending:{name:"formSending",doc:"Triggered when a form has been serialized we are awaiting the server response. Provides access to the form object as event.form",attr:["form"],toString:function(){return this.name}},formSent:{name:"formSent",doc:"Triggered when a server response to a form send has been recieved. Provides access to the response as event.data",attr:["data"],
toString:function(){return this.name}}};pb.api.getPlingDetails=function(){$.getJSON(pb.config.plings_endpoint+pb.config.pling_id.toString()+".json?suppressLinkedActivities=true&callback=?",pb.api.pling_loaded)};pb.api.pling_loaded=function(b){pb.config.pling=b.activity;pb.config.mode=Date.parseString(pb.config.pling.Starts,"yyyy-MM-dd HH:mm:ss").isBefore(new Date)?"after":"before";b=jQuery.Event(pb.api.events.plingLoaded.toString());b.pling=pb.config.pling;pb.api.trigger(b)};
pb.api.send=function(b){var d=null;d=b.target.tagName==="FORM"?$(b.target):$(b.target.form);var e={};e.pling_id=pb.config.pling_id;e.plingback_type=pb.config.plingback_type;e.plingback_version=pb.config.plingback_version;$("input",d).each(function(){$(this).val($(this).val()===$(this).data("pb_hint")?"":$(this).val())});d.serializeArray();jQuery.each(d.serializeArray(),function(a,f){if(f.value===0||f.value)if(e.hasOwnProperty(f.name))if(e[f.name]instanceof Array)e[f.name].push(f.value);else e[f.name]=
[e[f.name],f.value];else e[f.name]=f.value});b=pb.config.plingback_endpoint;var c="post";if(pb.config.feedback_id){e.feedback_id=pb.config.feedback_id;b+="/";b+=pb.config.feedback_id;c="put";if(pb.config.feedback_uri){c="post";b+="/";b+=e.feedback_attribute}if($("input[name=mode]",d).val()==="overwrite")c="put"}jQuery.ajax({type:c,url:b,data:e,success:pb.api.sendCallback,dataType:"json"});b=jQuery.Event(pb.api.events.formSending.toString());b.form=d;pb.api.trigger(b);return false};
pb.api.sendCallback=function(b){pb.config.feedback_id=b.feedback_id;pb.config.feedback_uri=b.feedback_uri;var d=jQuery.Event(pb.api.events.formSent.toString());d.data=b;pb.api.trigger(d)};pb.utils={};pb.utils.getParameterByName=function(b){b=b.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");b=RegExp("[\\?&]"+b+"=([^&#]*)").exec(window.location.href);return b===null?"":b[1]};
pb.utils.genUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var d=Math.random()*16|0;return(b=="x"?d:d&3|8).toString(16)}).toUpperCase()};pb.utils.validateEmail=function(b){return/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i.test(b)};
pb.utils.validatePhone=function(b){return/^((\+\d{1,3}(-| |\s)?\(?\d\)?(-| |\s)?\d{1,5})|(\(?\d{2,6}\)?))(-| |\s)?(\d{3,4})(-| |\s)?(\d{4})(( x| ext)\d{1,5}){0,1}$/.test(b.replace(/\s+/g,""))};
